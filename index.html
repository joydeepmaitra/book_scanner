<!DOCTYPE html><html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Scanner (Local)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.0.2/tesseract.min.js"></script>
    <script src="https://docs.opencv.org/master/opencv.js"></script>
</head>
<body>
    <h1>Scan Book Cover (Offline)</h1>
    <video id="camera" autoplay playsinline></video>
    <button onclick="captureImage()">Capture Image</button>
    <canvas id="canvas" style="display:none;"></canvas>
    <p id="error-message" style="color:red;"></p><h2>Extracted Book Details</h2>
<input type="text" id="title" placeholder="Book Title" readonly>
<input type="text" id="author" placeholder="Author Name" readonly>
<button onclick="saveBook()">Save to Table</button>

<h2>Book List</h2>
<table border="1" id="bookTable">
    <tr><th>Title</th><th>Author</th></tr>
</table>
<button onclick="exportCSV()">Export as CSV</button>

<script>
    let videoStream;
    
    async function startCamera() {
        try {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error("Camera access is not supported on this device/browser.");
            }
            videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            document.getElementById('camera').srcObject = videoStream;
        } catch (error) {
            document.getElementById('error-message').innerText = "Camera access denied or unavailable: " + error.message;
            console.error("Camera error:", error);
        }
    }

    function captureImage() {
        if (!videoStream) {
            alert("Camera not initialized. Try refreshing the page and allowing camera access.");
            return;
        }
        
        const video = document.getElementById('camera');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        let imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        let processedImage = preprocessImage(imageData);
        processImage(processedImage);
    }

    function preprocessImage(imageData) {
        let src = cv.matFromImageData(imageData);
        let dst = new cv.Mat();
        cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY); // Convert to grayscale
        cv.GaussianBlur(dst, dst, new cv.Size(5, 5), 0, 0, cv.BORDER_DEFAULT); // Reduce noise
        cv.adaptiveThreshold(dst, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 11, 2); // Improve contrast
        cv.Canny(dst, dst, 50, 200); // Apply edge detection
        
        let processedCanvas = document.createElement("canvas");
        processedCanvas.width = dst.cols;
        processedCanvas.height = dst.rows;
        let processedCtx = processedCanvas.getContext("2d");
        let processedImageData = new ImageData(new Uint8ClampedArray(dst.data), dst.cols, dst.rows);
        processedCtx.putImageData(processedImageData, 0, 0);
        
        src.delete();
        dst.delete();
        return processedCanvas.toDataURL('image/png');
    }

    function processImage(imageData) {
        Tesseract.recognize(
            imageData,
            'eng',
            {
                logger: m => console.log(m),
                tessedit_pageseg_mode: 6, // Detect text blocks better
                oem: 1 // Use deep learning OCR
            }
        ).then(({ data: { text } }) => {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            if (lines.length > 1) {
                document.getElementById('title').value = lines[0] || "";
                document.getElementById('author').value = lines[1] || "";
            } else {
                document.getElementById('title').value = text || "Text not recognized, try again.";
            }
        });
    }
    
    function saveBook() {
        const title = document.getElementById('title').value;
        const author = document.getElementById('author').value;
        
        if (!title || !author) {
            alert("No extracted data available!");
            return;
        }
        
        const table = document.getElementById('bookTable');
        const row = table.insertRow(-1);
        row.insertCell(0).innerText = title;
        row.insertCell(1).innerText = author;
        
        saveToLocalStorage();
    }
    
    function saveToLocalStorage() {
        const books = [];
        const rows = document.querySelectorAll("#bookTable tr:not(:first-child)");
        rows.forEach(row => {
            books.push({
                title: row.cells[0].innerText,
                author: row.cells[1].innerText
            });
        });
        localStorage.setItem("bookList", JSON.stringify(books));
    }
    
    function loadFromLocalStorage() {
        const books = JSON.parse(localStorage.getItem("bookList")) || [];
        books.forEach(book => {
            const table = document.getElementById('bookTable');
            const row = table.insertRow(-1);
            row.insertCell(0).innerText = book.title;
            row.insertCell(1).innerText = book.author;
        });
    }
    
    document.addEventListener("DOMContentLoaded", () => {
        startCamera();
        loadFromLocalStorage();
    });
</script>

</body>
</html>
